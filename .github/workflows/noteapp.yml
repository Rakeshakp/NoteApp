name: Send Test Report

on:
  workflow_run:
    workflows: ["Run Tests"]  # Replace with your actual test workflow name
    types:
      - completed

jobs:
  send-email:
    runs-on: ubuntu-latest
    steps:
      - name: Load secrets from Doppler
        uses: dopplerhq/cli-action@v2
        with:
          doppler-token: ${{ secrets.DOPPLER_TOKEN }}
          project: github-email         
          config: dev                   

      - name: Set dynamic subject
        run: |
          if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
            echo "SUBJECT= Test Passed: GitHub Actions Report" >> $GITHUB_ENV
          else
            echo "SUBJECT= Test Failed: GitHub Actions Report" >> $GITHUB_ENV
          fi

      - name: Download artifacts
        uses: actions/download-artifact@v3
        with:
          name: test-report
          path: reports

      - name: Send email with report
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.office365.com
          server_port: 587
          username: ${{ env.MAIL_USERNAME }}
          password: ${{ env.MAIL_PASSWORD }} 
          subject: ${{ env.SUBJECT }}
          to: rakeshkaader@outlook.com
          from: ${{ env.MAIL_USERNAME }}
          body: |
            Hello,

            The latest test run has ${{ github.event.workflow_run.conclusion }}.
            Please find the attached report files.

            Regards,  
            GitHub Actions
          attachments: |
            reports/log.html
            reports/report.html
            reports/output.xml
